import { DBAbstractProjector } from "./DBAbstractProjector";
import { AccountCreatedEvent } from "../domain/events/AccountCreatedEvent";
import { AccountDebitedEvent } from "../domain/events/AccountDebitedEvent";
import { AccountCreditedEvent } from "../domain/events/AccountCreditedEvent";
import { BalancesProjection } from "./projections/BalancesProjection";
import { IncomingEvent } from "../tech/impl/events/IncomingEvent";
import { Queryable } from "../tech/db/Queryable";
import { MoneyRoundingService } from "../domain/domain-services/MoneyRoundingService";

export class BalancesProjector extends DBAbstractProjector
{
    constructor(
        private projection: BalancesProjection,
        private roundService: MoneyRoundingService
    ) {
        super();
    }

    public getId(): string {
        return 'com.herrdoktor.projections.account_balances';
    }

    public getEventsOfInterest(): string[] {
        return [
            AccountCreatedEvent.EventName,
            AccountCreditedEvent.EventName,
            AccountDebitedEvent.EventName,
        ];
    }

    private async handleAccountCreated(event: IncomingEvent, connection: Queryable): Promise<void> {
        const payload = event.getPayload();

        return Promise.all([
            this.projection.createBalance(connection, payload['id'], 'EUR', 0),
            this.projection.createBalance(connection, payload['id'], 'USD', 0)
        ]).then(() => undefined);
    }

    private async handleAccountCredited(event: IncomingEvent, connection: Queryable): Promise<void> {
        const payload = event.getPayload();
        
        return this.projection
            .updateBalance(connection, payload['id'], payload['currency'], this.roundService.toCents(payload['amount']));
    }

    private async handleAccountDebited(event: IncomingEvent, connection: Queryable): Promise<void> {
        const payload = event.getPayload();

        return this.projection
            .updateBalance(connection, payload['id'], payload['currency'], -this.roundService.toCents(payload['amount']));
    }

    async handleIncomingEvent(event: IncomingEvent, connection: Queryable): Promise<void> {
        switch (event.getName()) {
            case AccountCreatedEvent.EventName:
                return this.handleAccountCreated(event, connection);

            case AccountCreditedEvent.EventName:
                return this.handleAccountCredited(event, connection);

            case AccountDebitedEvent.EventName:
                return this.handleAccountDebited(event, connection);
        }

    }

    async handleClear(connection: Queryable): Promise<void> {
        return this.projection.clear(connection);
    }

}